<view class="page">
  <view class="card">
    <view class="row">
      <view class="title">{{title}}</view>
      <view class="muted">{{rangeLabel}}</view>
    </view>
    <view class="row" style="margin-top: 10rpx; flex-wrap: wrap; justify-content:flex-start;">
      <button size="mini" bindtap="setRange" data-k="1m">近一月</button>
      <button size="mini" bindtap="setRange" data-k="3m">近三月</button>
      <button size="mini" bindtap="setRange" data-k="6m">近半年</button>
      <button size="mini" bindtap="setRange" data-k="1y">近一年</button>
      <button size="mini" bindtap="setRange" data-k="3y">近三年</button>
      <button size="mini" bindtap="setRange" data-k="5y">近五年</button>
      <button size="mini" bindtap="setRange" data-k="10y">近十年</button>
      <button size="mini" bindtap="setRange" data-k="all">全区间</button>
    </view>
    <view class="muted" style="margin-top: 8rpx;">{{status}}</view>
    <view wx:if="{{pageKey==='mix'}}" class="muted" style="margin-top: 8rpx;">
      说明：综合净值=周一~周五五个版本净值的逐日等权合成（每个调仓日各占20%资金），用于观察“平均执行”的运营效果；不是简单平均指标。
    </view>
  </view>

  <view class="card">
    <view class="title">图表1：等权净值 + EMA252 + 布林带</view>
    <view class="canvasWrap">
      <!-- height +50% (300rpx -> 450rpx) -->
      <canvas canvas-id="cNav" id="cNav" bindtouchstart="onChartTouch" bindtouchmove="onChartTouch" bindtouchend="onChartTouchEnd" style="width: 100%; height: 450rpx;"></canvas>
      <!-- canvas is a native component; overlays must use cover-view on real devices -->
      <cover-view wx:if="{{tip.show && tip.id==='cNav'}}" class="crossV" style="left:{{tip.cx}}px; height:{{tip.ch}}px;"></cover-view>
      <cover-view wx:if="{{tip.show && tip.id==='cNav'}}" class="tip" style="left:{{tip.x}}px; top:{{tip.y}}px;">{{tip.text}}</cover-view>
    </view>
  </view>

  <view class="card">
    <view class="title">图表2：回撤</view>
    <view class="canvasWrap">
      <canvas canvas-id="cDD" id="cDD" bindtouchstart="onChartTouch" bindtouchmove="onChartTouch" bindtouchend="onChartTouchEnd" style="width: 100%; height: 240rpx;"></canvas>
      <cover-view wx:if="{{tip.show && tip.id==='cDD'}}" class="crossV" style="left:{{tip.cx}}px; height:{{tip.ch}}px;"></cover-view>
      <cover-view wx:if="{{tip.show && tip.id==='cDD'}}" class="tip" style="left:{{tip.x}}px; top:{{tip.y}}px;">{{tip.text}}</cover-view>
    </view>
  </view>

  <view class="card">
    <view class="title">图表3：RSI(24)</view>
    <view class="canvasWrap">
      <canvas canvas-id="cRSI" id="cRSI" bindtouchstart="onChartTouch" bindtouchmove="onChartTouch" bindtouchend="onChartTouchEnd" style="width: 100%; height: 220rpx;"></canvas>
      <cover-view wx:if="{{tip.show && tip.id==='cRSI'}}" class="crossV" style="left:{{tip.cx}}px; height:{{tip.ch}}px;"></cover-view>
      <cover-view wx:if="{{tip.show && tip.id==='cRSI'}}" class="tip" style="left:{{tip.x}}px; top:{{tip.y}}px;">{{tip.text}}</cover-view>
    </view>
  </view>

  <view class="card">
    <view class="title">图表4：滚动三年收益率</view>
    <view class="canvasWrap">
      <canvas canvas-id="cRR3Y" id="cRR3Y" bindtouchstart="onChartTouch" bindtouchmove="onChartTouch" bindtouchend="onChartTouchEnd" style="width: 100%; height: 220rpx;"></canvas>
      <cover-view wx:if="{{tip.show && tip.id==='cRR3Y'}}" class="crossV" style="left:{{tip.cx}}px; height:{{tip.ch}}px;"></cover-view>
      <cover-view wx:if="{{tip.show && tip.id==='cRR3Y'}}" class="tip" style="left:{{tip.x}}px; top:{{tip.y}}px;">{{tip.text}}</cover-view>
    </view>
  </view>

  <view class="card">
    <view class="title">图表5：滚动三年回撤</view>
    <view class="canvasWrap">
      <canvas canvas-id="cRDD3Y" id="cRDD3Y" bindtouchstart="onChartTouch" bindtouchmove="onChartTouch" bindtouchend="onChartTouchEnd" style="width: 100%; height: 220rpx;"></canvas>
      <cover-view wx:if="{{tip.show && tip.id==='cRDD3Y'}}" class="crossV" style="left:{{tip.cx}}px; height:{{tip.ch}}px;"></cover-view>
      <cover-view wx:if="{{tip.show && tip.id==='cRDD3Y'}}" class="tip" style="left:{{tip.x}}px; top:{{tip.y}}px;">{{tip.text}}</cover-view>
    </view>
  </view>

  <view class="card">
    <view class="title">图表6：绩效指标</view>
    <view class="muted">累计收益：{{m.cumulative_return}}｜年化收益：{{m.annualized_return}}｜年化波动：{{m.annualized_volatility}}</view>
    <view class="muted">最大回撤：{{m.max_drawdown}}｜修复时长：{{m.max_drawdown_recovery_days}}天</view>
    <view class="muted">夏普：{{m.sharpe_ratio}}｜卡玛：{{m.calmar_ratio}}｜索诺提：{{m.sortino_ratio}}</view>
    <view class="muted">溃疡(UI)：{{m.ulcer_index}}｜UPI：{{m.ulcer_performance_index}}</view>
  </view>

  <view class="card">
    <view class="title">图表7：收益贡献（Return Contribution）</view>
    <canvas canvas-id="cRC" id="cRC" style="width: 100%; height: 220rpx;"></canvas>
  </view>

  <view class="card">
    <view class="title">图表8：风险贡献（Risk Share）</view>
    <canvas canvas-id="cRiskC" id="cRiskC" style="width: 100%; height: 220rpx;"></canvas>
  </view>

  <view class="card">
    <view class="title">图表9：相关性（Pearson）</view>
    <view class="muted" style="margin-top: 8rpx;">
      <block wx:for="{{corrMapLines}}" wx:key="*this">
        <view>{{item}}</view>
      </block>
      <view style="margin-top: 6rpx;">颜色：红=正相关，绿=负相关</view>
    </view>
    <view class="row" style="justify-content:center; margin-top: 8rpx;">
      <canvas canvas-id="cCorr" id="cCorr" style="width: 94%; height: 380rpx;"></canvas>
    </view>
  </view>

  <view class="card">
    <view class="title">图表10：组合收益率日历（日/月/年）</view>
    <view class="row" style="margin-top: 10rpx; flex-wrap: wrap; justify-content:flex-start;">
      <button size="mini" bindtap="setCalMode" data-m="daily">日度</button>
      <button size="mini" bindtap="setCalMode" data-m="monthly">月度</button>
      <button size="mini" bindtap="setCalMode" data-m="yearly">年度</button>
      <view class="muted" style="margin-left: 10rpx;">当前：{{calModeLabel}}</view>
    </view>

    <!-- Daily calendar: one month -->
    <view wx:if="{{calMode==='daily'}}" style="margin-top: 12rpx;">
      <view class="row" style="justify-content:space-between;">
        <button size="mini" bindtap="prevCalMonth">上一月</button>
        <view class="muted">{{calDailyMonth}}</view>
        <button size="mini" bindtap="nextCalMonth">下一月</button>
      </view>
      <view class="cal-grid" style="margin-top: 10rpx;">
        <view class="cal-head">日</view>
        <view class="cal-head">一</view>
        <view class="cal-head">二</view>
        <view class="cal-head">三</view>
        <view class="cal-head">四</view>
        <view class="cal-head">五</view>
        <view class="cal-head">六</view>

        <block wx:for="{{calDailyCells}}" wx:key="k">
          <view class="cal-cell {{item.kind}}">
            <view class="cal-day">{{item.dayText}}</view>
            <view class="cal-ret">{{item.retText}}</view>
          </view>
        </block>
      </view>
      <view class="muted" style="margin-top: 8rpx;">
        说明：仅交易日显示收益；周日为一周第一天，周六为最后一天。
      </view>
    </view>

    <!-- Monthly calendar: one year (switchable) -->
    <view wx:if="{{calMode==='monthly'}}" style="margin-top: 12rpx;">
      <view class="row" style="justify-content:space-between;">
        <button size="mini" bindtap="prevCalYear">上一年</button>
        <view class="muted">{{calMonthlyYear}}</view>
        <button size="mini" bindtap="nextCalYear">下一年</button>
      </view>
      <view class="mon-grid" style="margin-top: 10rpx;">
        <block wx:for="{{calMonthlyCells}}" wx:key="k">
          <view class="mon-cell {{item.kind}}">
            <view class="mon-title">{{item.title}}</view>
            <view class="mon-ret">{{item.retText}}</view>
          </view>
        </block>
      </view>
    </view>

    <!-- Yearly calendar: 4 columns -->
    <view wx:if="{{calMode==='yearly'}}" style="margin-top: 12rpx;">
      <view class="row" style="justify-content:space-between; margin-bottom: 10rpx;">
        <button size="mini" bindtap="prevYearPage">上一页</button>
        <view class="muted">每页最多 12 年｜第 {{calYearlyPage}} 页</view>
        <button size="mini" bindtap="nextYearPage">下一页</button>
      </view>
      <view class="yr-grid">
        <block wx:for="{{calYearlyCells}}" wx:key="year">
          <view class="yr-cell {{item.kind}}">
            <view class="yr-title">{{item.year}}</view>
            <view class="yr-ret">{{item.retText}}</view>
          </view>
        </block>
      </view>
    </view>
  </view>

  <!-- ================= Rotation Strategy Section ================= -->
  <view class="card">
    <view class="title">轮动策略（固定参数：周频 / Top1 / 回看20 / 开盘价执行 / 无风控）</view>
    <view class="muted">展示区间与上方等权组合一致</view>
  </view>

  <view class="card">
    <view class="title">轮动图表1：策略净值 vs 等权净值</view>
    <view class="canvasWrap">
      <canvas canvas-id="rNav" id="rNav" bindtouchstart="onChartTouch" bindtouchmove="onChartTouch" bindtouchend="onChartTouchEnd" style="width: 100%; height: 450rpx;"></canvas>
      <cover-view wx:if="{{tip.show && tip.id==='rNav'}}" class="crossV" style="left:{{tip.cx}}px; height:{{tip.ch}}px;"></cover-view>
      <cover-view wx:if="{{tip.show && tip.id==='rNav'}}" class="tip" style="left:{{tip.x}}px; top:{{tip.y}}px;">{{tip.text}}</cover-view>
    </view>
  </view>

  <view class="card">
    <view class="title">轮动图表2：回撤对比（策略 vs 等权）</view>
    <view class="canvasWrap">
      <canvas canvas-id="rDD" id="rDD" bindtouchstart="onChartTouch" bindtouchmove="onChartTouch" bindtouchend="onChartTouchEnd" style="width: 100%; height: 260rpx;"></canvas>
      <cover-view wx:if="{{tip.show && tip.id==='rDD'}}" class="crossV" style="left:{{tip.cx}}px; height:{{tip.ch}}px;"></cover-view>
      <cover-view wx:if="{{tip.show && tip.id==='rDD'}}" class="tip" style="left:{{tip.x}}px; top:{{tip.y}}px;">{{tip.text}}</cover-view>
    </view>
  </view>

  <view class="card">
    <view class="title">轮动图表3：策略净值 RSI(24)</view>
    <view class="canvasWrap">
      <canvas canvas-id="rRSI" id="rRSI" bindtouchstart="onChartTouch" bindtouchmove="onChartTouch" bindtouchend="onChartTouchEnd" style="width: 100%; height: 220rpx;"></canvas>
      <cover-view wx:if="{{tip.show && tip.id==='rRSI'}}" class="crossV" style="left:{{tip.cx}}px; height:{{tip.ch}}px;"></cover-view>
      <cover-view wx:if="{{tip.show && tip.id==='rRSI'}}" class="tip" style="left:{{tip.x}}px; top:{{tip.y}}px;">{{tip.text}}</cover-view>
    </view>
  </view>

  <view class="card">
    <view class="title">轮动图表4：策略滚动三年收益率</view>
    <view class="canvasWrap">
      <canvas canvas-id="rRR3Y" id="rRR3Y" bindtouchstart="onChartTouch" bindtouchmove="onChartTouch" bindtouchend="onChartTouchEnd" style="width: 100%; height: 220rpx;"></canvas>
      <cover-view wx:if="{{tip.show && tip.id==='rRR3Y'}}" class="crossV" style="left:{{tip.cx}}px; height:{{tip.ch}}px;"></cover-view>
      <cover-view wx:if="{{tip.show && tip.id==='rRR3Y'}}" class="tip" style="left:{{tip.x}}px; top:{{tip.y}}px;">{{tip.text}}</cover-view>
    </view>
  </view>

  <view class="card">
    <view class="title">轮动图表5：策略滚动三年回撤</view>
    <view class="canvasWrap">
      <canvas canvas-id="rMDD3Y" id="rMDD3Y" bindtouchstart="onChartTouch" bindtouchmove="onChartTouch" bindtouchend="onChartTouchEnd" style="width: 100%; height: 220rpx;"></canvas>
      <cover-view wx:if="{{tip.show && tip.id==='rMDD3Y'}}" class="crossV" style="left:{{tip.cx}}px; height:{{tip.ch}}px;"></cover-view>
      <cover-view wx:if="{{tip.show && tip.id==='rMDD3Y'}}" class="tip" style="left:{{tip.x}}px; top:{{tip.y}}px;">{{tip.text}}</cover-view>
    </view>
  </view>

  <view class="card">
    <view class="title">轮动图表6：净值比值 ROT/EW + EMA252 + 布林带</view>
    <view class="canvasWrap">
      <canvas canvas-id="rRatio" id="rRatio" bindtouchstart="onChartTouch" bindtouchmove="onChartTouch" bindtouchend="onChartTouchEnd" style="width: 100%; height: 300rpx;"></canvas>
      <cover-view wx:if="{{tip.show && tip.id==='rRatio'}}" class="crossV" style="left:{{tip.cx}}px; height:{{tip.ch}}px;"></cover-view>
      <cover-view wx:if="{{tip.show && tip.id==='rRatio'}}" class="tip" style="left:{{tip.x}}px; top:{{tip.y}}px;">{{tip.text}}</cover-view>
    </view>
  </view>

  <view class="card">
    <view class="title">轮动图表7：超额回撤（基于 ROT/EW 比值）</view>
    <view class="canvasWrap">
      <canvas canvas-id="rExDD" id="rExDD" bindtouchstart="onChartTouch" bindtouchmove="onChartTouch" bindtouchend="onChartTouchEnd" style="width: 100%; height: 220rpx;"></canvas>
      <cover-view wx:if="{{tip.show && tip.id==='rExDD'}}" class="crossV" style="left:{{tip.cx}}px; height:{{tip.ch}}px;"></cover-view>
      <cover-view wx:if="{{tip.show && tip.id==='rExDD'}}" class="tip" style="left:{{tip.x}}px; top:{{tip.y}}px;">{{tip.text}}</cover-view>
    </view>
  </view>

  <view class="card">
    <view class="title">轮动图表8：比值曲线 RSI(24)</view>
    <view class="canvasWrap">
      <canvas canvas-id="rRatioRSI" id="rRatioRSI" bindtouchstart="onChartTouch" bindtouchmove="onChartTouch" bindtouchend="onChartTouchEnd" style="width: 100%; height: 220rpx;"></canvas>
      <cover-view wx:if="{{tip.show && tip.id==='rRatioRSI'}}" class="crossV" style="left:{{tip.cx}}px; height:{{tip.ch}}px;"></cover-view>
      <cover-view wx:if="{{tip.show && tip.id==='rRatioRSI'}}" class="tip" style="left:{{tip.x}}px; top:{{tip.y}}px;">{{tip.text}}</cover-view>
    </view>
  </view>

  <view class="card">
    <view class="title">轮动图表9：40日收益差（策略 - 等权）</view>
    <view class="canvasWrap">
      <canvas canvas-id="rDiff40" id="rDiff40" bindtouchstart="onChartTouch" bindtouchmove="onChartTouch" bindtouchend="onChartTouchEnd" style="width: 100%; height: 220rpx;"></canvas>
      <cover-view wx:if="{{tip.show && tip.id==='rDiff40'}}" class="crossV" style="left:{{tip.cx}}px; height:{{tip.ch}}px;"></cover-view>
      <cover-view wx:if="{{tip.show && tip.id==='rDiff40'}}" class="tip" style="left:{{tip.x}}px; top:{{tip.y}}px;">{{tip.text}}</cover-view>
    </view>
  </view>

  <view class="card">
    <view class="title">轮动图表10：策略绩效指标（含超额）</view>
    <view class="muted">累计收益：{{rm.cumulative_return}}｜年化收益：{{rm.annualized_return}}｜年化波动：{{rm.annualized_volatility}}</view>
    <view class="muted">最大回撤：{{rm.max_drawdown}}｜修复时长：{{rm.max_drawdown_recovery_days}}天</view>
    <view class="muted">夏普：{{rm.sharpe_ratio}}｜卡玛：{{rm.calmar_ratio}}｜索诺提：{{rm.sortino_ratio}}</view>
    <view class="muted">溃疡：{{rm.ulcer_index}}｜溃疡绩效：{{rm.ulcer_performance_index}}</view>
    <view class="muted">累积超额：{{rm.excess_cum}}｜超额年化：{{rm.excess_ann}}｜超额波动：{{rm.excess_volatility}}</view>
    <view class="muted">超额最大回撤：{{rm.excess_max_drawdown}}｜超额修复时长：{{rm.excess_max_drawdown_recovery_days}}天</view>
    <view class="muted">超额胜率：{{rm.excess_win_rate}}｜平均正超额：{{rm.excess_avg_win}}｜平均负超额：{{rm.excess_avg_loss}}</view>
    <view class="muted">信息比率：{{rm.excess_ir}}｜年换手率：{{rm.annual_turnover}}</view>
  </view>

  <view class="card">
    <view class="title">轮动图表11：标的收益贡献</view>
    <canvas canvas-id="rRC" id="rRC" style="width: 100%; height: 220rpx;"></canvas>
  </view>

  <view class="card">
    <view class="title">轮动图表12：标的风险贡献</view>
    <canvas canvas-id="rRiskC" id="rRiskC" style="width: 100%; height: 220rpx;"></canvas>
  </view>

  <view class="card">
    <view class="title">轮动图表13：策略收益率日历（日/月/年）</view>
    <view class="row" style="margin-top: 10rpx; flex-wrap: wrap; justify-content:flex-start;">
      <button size="mini" bindtap="setRotCalMode" data-m="daily">日度</button>
      <button size="mini" bindtap="setRotCalMode" data-m="monthly">月度</button>
      <button size="mini" bindtap="setRotCalMode" data-m="yearly">年度</button>
      <view class="muted" style="margin-left: 10rpx;">当前：{{rotCalModeLabel}}</view>
    </view>

    <view wx:if="{{rotCalMode==='daily'}}" style="margin-top: 12rpx;">
      <view class="row" style="justify-content:space-between;">
        <button size="mini" bindtap="prevRotCalMonth">上一月</button>
        <view class="muted">{{rotCalDailyMonth}}</view>
        <button size="mini" bindtap="nextRotCalMonth">下一月</button>
      </view>
      <view class="cal-grid" style="margin-top: 10rpx;">
        <view class="cal-head">日</view>
        <view class="cal-head">一</view>
        <view class="cal-head">二</view>
        <view class="cal-head">三</view>
        <view class="cal-head">四</view>
        <view class="cal-head">五</view>
        <view class="cal-head">六</view>
        <block wx:for="{{rotCalDailyCells}}" wx:key="k">
          <view class="cal-cell {{item.kind}}">
            <view class="cal-day">{{item.dayText}}</view>
            <view class="cal-ret">{{item.retText}}</view>
          </view>
        </block>
      </view>
    </view>

    <view wx:if="{{rotCalMode==='monthly'}}" style="margin-top: 12rpx;">
      <view class="row" style="justify-content:space-between;">
        <button size="mini" bindtap="prevRotCalYear">上一年</button>
        <view class="muted">{{rotCalMonthlyYear}}</view>
        <button size="mini" bindtap="nextRotCalYear">下一年</button>
      </view>
      <view class="mon-grid" style="margin-top: 10rpx;">
        <block wx:for="{{rotCalMonthlyCells}}" wx:key="k">
          <view class="mon-cell {{item.kind}}">
            <view class="mon-title">{{item.title}}</view>
            <view class="mon-ret">{{item.retText}}</view>
          </view>
        </block>
      </view>
    </view>

    <view wx:if="{{rotCalMode==='yearly'}}" style="margin-top: 12rpx;">
      <view class="row" style="justify-content:space-between; margin-bottom: 10rpx;">
        <button size="mini" bindtap="prevRotYearPage">上一页</button>
        <view class="muted">每页最多 12 年｜第 {{rotCalYearlyPage}} 页</view>
        <button size="mini" bindtap="nextRotYearPage">下一页</button>
      </view>
      <view class="yr-grid">
        <block wx:for="{{rotCalYearlyCells}}" wx:key="year">
          <view class="yr-cell {{item.kind}}">
            <view class="yr-title">{{item.year}}</view>
            <view class="yr-ret">{{item.retText}}</view>
          </view>
        </block>
      </view>
    </view>
  </view>

  <view class="card">
    <view class="title">轮动图表14：逐期收益对比（策略 vs 等权）</view>
    <view class="muted">{{rotPeriodPageText}}</view>
    <view class="row" style="justify-content:space-between; margin-top: 10rpx;">
      <button size="mini" bindtap="prevRotPeriodPage">上一页</button>
      <button size="mini" bindtap="nextRotPeriodPage">下一页</button>
    </view>
    <view style="margin-top: 10rpx;">
      <block wx:for="{{rotPeriodsView}}" wx:key="k">
        <view style="margin: 10rpx 0;">
          <view class="muted line-ellipsis">
            {{item.exec_date}}｜策 {{item.strategy_return_text}} / 等 {{item.equal_weight_return_text}} / 超 {{item.excess_return_text}}｜{{item.trade_text}}
          </view>
        </view>
      </block>
    </view>
  </view>

  <view class="card">
    <view class="title">轮动图表15：下一调仓日计划</view>
    <view wx:if="{{nextPlan && nextPlan.rebalance_effective_next_day}}" class="muted">
      下一交易日（{{nextPlan.next_trading_day}}）为调仓执行日；计划持有：{{nextPlan.pick_name}}（{{nextPlan.pick_code}}）
    </view>
    <view wx:if="{{nextPlan && !nextPlan.rebalance_effective_next_day}}" class="muted">
      下一交易日（{{nextPlan.next_trading_day}}）非调仓执行日
    </view>
    <view wx:if="{{!nextPlan}}" class="muted">计划未加载</view>
  </view>

  <!-- spacer so bottom nav won't cover content -->
  <view style="height: 140rpx;"></view>

  <!-- Bottom navigation: 综合 + 周一~周五 -->
  <!-- Use cover-view to stay above canvas (native component) on real devices -->
  <cover-view class="bottomNav">
    <cover-view class="navItem {{pageKey==='mix'?'navItemActive':''}}" bindtap="switchPage" data-p="mix" hover-class="navItemHover">综合</cover-view>
    <cover-view class="navItem {{pageKey==='wd0'?'navItemActive':''}}" bindtap="switchPage" data-p="wd0" hover-class="navItemHover">周一</cover-view>
    <cover-view class="navItem {{pageKey==='wd1'?'navItemActive':''}}" bindtap="switchPage" data-p="wd1" hover-class="navItemHover">周二</cover-view>
    <cover-view class="navItem {{pageKey==='wd2'?'navItemActive':''}}" bindtap="switchPage" data-p="wd2" hover-class="navItemHover">周三</cover-view>
    <cover-view class="navItem {{pageKey==='wd3'?'navItemActive':''}}" bindtap="switchPage" data-p="wd3" hover-class="navItemHover">周四</cover-view>
    <cover-view class="navItem {{pageKey==='wd4'?'navItemActive':''}}" bindtap="switchPage" data-p="wd4" hover-class="navItemHover">周五</cover-view>
  </cover-view>
</view>

