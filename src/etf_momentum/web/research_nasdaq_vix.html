<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>研究：纳指（NDX/QQQ/513100）× VXN（Cboe）</title>
    <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 24px; }
      .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; }
      label { display: block; font-size: 12px; color: #444; margin-bottom: 4px; }
      input, select { padding: 8px; min-width: 160px; }
      button { padding: 8px 12px; cursor: pointer; }
      .muted { color: #666; font-size: 12px; }
      .panel { margin-top: 14px; }
      .two { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
      table { border-collapse: collapse; width: 100%; }
      th, td { border-bottom: 1px solid #ddd; padding: 8px; text-align: left; font-size: 13px; }
      th { background: #f7f7f7; }
      #pxChart, #retChart, #xcorrChart { width: 100%; height: 360px; }
      #stratChart, #vixBtChart, #rollingChart { width: 100%; height: 360px; }
      #distCloseChart, #distRetChart { width: 100%; height: 320px; }
      .msg { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; }
    </style>
  </head>
  <body>
    <h2>研究：纳指（NDX / QQQ / 513100）与 VXN（Cboe）</h2>
    <div class="muted">
      目标：检查“纳指资产”与 VXN（纳指恐慌指数）之间的相关性、领先/同步/滞后关系，以及 Granger 因果检验（收益率层面）。
      <div style="margin-top: 6px;">
        <a href="/">返回候选池</a>
        <span style="margin: 0 6px;">|</span>
        <a href="/research">返回基准分析</a>
      </div>
    </div>

    <div class="panel">
      <details>
        <summary style="cursor:pointer; user-select:none;">结果解读说明（点击展开）</summary>
        <div class="muted" style="margin-top: 8px; line-height: 1.65;">
          <div><b>1) relation / best_lag / best_corr</b></div>
          <div>
            - 我们用“日收益率（log-ret）”做互相关。<br/>
            - <b>best_lag=1</b> 表示：用 <b>VIX 的 t-1</b> 去对齐 <b>ETF 的 t</b>，此时相关最强（=VIX 领先 1 个交易日）。<br/>
            - <b>best_corr 为负</b>：VIX 上升（风险上升）往往对应 ETF 下跌；VIX 下降往往对应 ETF 上涨。<br/>
            - pvalue 很小只说明“统计显著相关”，<b>不等于充要指标/稳定可交易</b>。
          </div>
          <div style="margin-top: 8px;"><b>2) Granger（因果检验）</b></div>
          <div>
            - idx→etf 显著：在“线性+滞后项”的模型下，加入 VIX 的过去值能提升对 ETF 收益的预测（Granger 意义）。<br/>
            - 若 etf→idx 也显著：更像是反馈/共同驱动，而非单向因果。
          </div>
          <div style="margin-top: 8px;"><b>3) 日期对齐（很重要）</b></div>
          <div>
            - Cboe 的 VIX 是美股收盘后的数值；若你做 A 股 ETF 实盘，通常应选择 <b>“US 收盘顺延到中国下一交易日”</b>，更贴近可用信息集。<br/>
          </div>
          <div style="margin-top: 8px;"><b>4) 交易可用性（direction / conditional / strategy / rolling）</b></div>
          <div>
            - <b>命中率/混淆矩阵</b>：把“预测涨/跌”当二分类，看 hit_rate、TP/TN/FP/FN（注意：高命中率不一定高收益）。<br/>
            - <b>条件分布</b>：对比 “VIX↑/VIX↓(信号日)” 两组下 ETF 次日收益的均值/分位数，判断是否存在“可利用的偏移”。<br/>
            - <b>简单策略回测</b>：仅作诊断（不是完整交易系统）。看 NAV、CAGR/Sharpe/MDD，并考虑成本（bps）敏感性。<br/>
            - <b>滚动稳定性</b>：若 rolling corr / rolling hit_rate 波动很大，说明关系可能阶段性、容易失效。
          </div>
          <div style="margin-top: 8px;"><b>5) 阈值信号与 Walk-forward</b></div>
          <div>
            - <b>阈值信号</b>：只有当 |VIX 日收益| 足够大时才允许改变仓位；<b>active_rate</b> 越低，交易越少（噪声更少但机会也更少）。<br/>
            - <b>Walk-forward</b>：在训练段选参数（lag、阈值），在测试段固定参数验证；重点看 <b>测试段</b> 是否仍有收益/Sharpe 优势。<br/>
          </div>
          <div style="margin-top: 8px;"><b>6) 实盘注意事项</b></div>
          <div>
            - 结构变化（制度/宏观/波动 regime）、样本外失效、交易成本与滑点、信号发布时间（信息可得性）都会影响可交易性。<br/>
          </div>
        </div>
      </details>
    </div>

    <div class="panel row">
      <div>
        <label>开始日期</label>
        <input id="start" placeholder="YYYYMMDD" />
      </div>
      <div>
        <label>结束日期</label>
        <input id="end" placeholder="YYYYMMDD" />
      </div>
      <div>
        <label>资产预设</label>
        <select id="assetPreset" title="选择预设会自动填充资产来源与symbol/代码。">
          <option value="db:513100" selected>513100（A股纳指ETF，DB）</option>
          <option value="stooq:qqq.us">QQQ（海外ETF，Stooq: qqq.us）</option>
          <option value="stooq:^ndx">NDX（纳斯达克100指数，Stooq: ^ndx）</option>
          <option value="custom:">custom（自定义）</option>
        </select>
      </div>
      <div>
        <label>资产 provider</label>
        <select id="assetProvider">
          <option value="db" selected>db</option>
          <option value="stooq">stooq</option>
          <option value="yahoo">yahoo</option>
          <option value="auto">auto</option>
        </select>
      </div>
      <div>
        <label>资产 symbol（外盘）</label>
        <input id="assetSymbol" value="" placeholder="例如 qqq.us 或 ^ndx" />
      </div>
      <div>
        <label>ETF 复权</label>
        <select id="adjust">
          <option value="hfq" selected>hfq（后复权）</option>
          <option value="qfq">qfq（前复权）</option>
          <option value="none">none（不复权）</option>
        </select>
      </div>
      <div>
        <label>指数预设</label>
        <select id="idxPreset" title="默认 VXN；也可自定义。">
          <option value="cboe:VXN" selected>VXN（Cboe 纳指恐慌指数）</option>
          <option value="cboe:VIX">VIX（Cboe 恐慌指数）</option>
          <option value="cboe:GVZ">GVZ（Cboe 黄金波动率）</option>
          <option value="custom:">custom（自定义）</option>
        </select>
      </div>
      <div>
        <label>指数 symbol</label>
        <input id="idx" value="VXN" />
      </div>
      <div>
        <label>数据源 provider</label>
        <select id="idxProvider">
          <option value="auto">auto</option>
          <option value="cboe" selected>cboe</option>
          <option value="stooq">stooq</option>
          <option value="yahoo">yahoo</option>
        </select>
      </div>
      <div>
        <label>日期对齐</label>
        <select id="align">
          <option value="cn_next_trading_day" selected>US 收盘顺延到中国下一交易日（推荐）</option>
          <option value="none">不做顺延（原始日期）</option>
        </select>
      </div>
      <div>
        <label>互相关最大滞后（天）</label>
        <input id="maxLag" value="20" />
      </div>
      <div>
        <label>Granger 最大阶数</label>
        <input id="grangerLag" value="10" />
      </div>
      <div>
        <label>显著性 α</label>
        <input id="alpha" value="0.05" />
      </div>
      <div>
        <label>成本（bps/换仓）</label>
        <input id="costBps" value="10" title="简单策略每次仓位变化收取成本（bps）。" />
      </div>
      <div>
        <label>阈值信号（|index_ret| 分位数）</label>
        <input id="thrQ" value="0.8" title="只有当 |指数 日收益| >= 该分位数阈值时才允许触发换仓。" />
      </div>
      <div>
        <label>Walk-forward 训练占比</label>
        <input id="trainRatio" value="0.6" title="训练/测试切分比例（按时间顺序）。" />
      </div>
      <div>
        <label>Walk-forward 目标</label>
        <select id="wfObj">
          <option value="sharpe" selected>最大化 Sharpe</option>
          <option value="cagr">最大化 CAGR</option>
        </select>
      </div>
      <div style="min-width: 220px;">
        <label>波动率择时（按指数 level 分位数分段仓位）</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <label style="margin:0; font-size:12px; color:#444;">
            <input type="checkbox" id="volOn" />
            启用
          </label>
          <span class="muted" title="示例：分位数=0.8,0.9；仓位=1,0.5,0.2（长度=分位数+1）">说明</span>
        </div>
      </div>
      <div>
        <label>level 分位数（逗号）</label>
        <input id="volQs" value="0.8,0.9" />
      </div>
      <div>
        <label>分段仓位（逗号）</label>
        <input id="volExps" value="1,0.5,0.2" />
      </div>
      <div>
        <label>分位数窗口（用于 VXN/现货波动 level）</label>
        <select id="volWindow" title="all=全样本分位数；1y/3y/5y/10y=滚动窗口分位数（按交易日近似）。">
          <option value="all" selected>全区间（all）</option>
          <option value="1y">近1年（1y）</option>
          <option value="3y">近3年（3y）</option>
          <option value="5y">近5年（5y）</option>
          <option value="10y">近10年（10y）</option>
        </select>
      </div>
      <div style="min-width: 260px;">
        <label>同时对比：现货波动择时（仅用 513100 价格）</label>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <label style="margin:0; font-size:12px; color:#444;">
            <input type="checkbox" id="proxyOn" checked />
            启用对比
          </label>
          <label style="margin:0; font-size:12px; color:#444;">
            <input type="checkbox" id="proxy_rv20" checked />
            RV20
          </label>
          <label style="margin:0; font-size:12px; color:#444;">
            <input type="checkbox" id="proxy_yz20" checked />
            Yang-Zhang20
          </label>
          <label style="margin:0; font-size:12px; color:#444;">
            <input type="checkbox" id="proxy_gk20" />
            Garman-Klass20
          </label>
          <label style="margin:0; font-size:12px; color:#444;">
            <input type="checkbox" id="proxy_ewma094" checked />
            EWMA(0.94)
          </label>
          <label style="margin:0; font-size:12px; color:#444;">
            <input type="checkbox" id="proxy_har252" checked />
            HAR(252)
          </label>
        </div>
        <div class="muted" style="margin-top:6px;">说明：现货波动择时需要 DB 中的 513100 OHLC；当你选择 QQQ/NDX（外盘）时将跳过该对比。</div>
      </div>
      <button id="run">运行分析</button>
    </div>

    <div id="msg" class="msg panel"></div>

    <div class="panel two">
      <div>
        <h3 style="margin: 0 0 6px 0;">价格（归一化）</h3>
        <div id="pxChart"></div>
      </div>
      <div>
        <h3 style="margin: 0 0 6px 0;">日收益率</h3>
        <div id="retChart"></div>
      </div>
    </div>

    <div class="panel">
      <h3 style="margin: 0 0 6px 0;">互相关（正滞后 = 指数领先 ETF）</h3>
      <div id="xcorrChart"></div>
    </div>

    <div class="panel two">
      <div>
        <h3 style="margin: 0 0 6px 0;">互相关明细</h3>
        <table id="xcorrTable"></table>
      </div>
      <div>
        <h3 style="margin: 0 0 6px 0;">Granger 因果检验</h3>
        <table id="grangerTable"></table>
      </div>
    </div>

    <div class="panel two">
      <div>
        <h3 style="margin: 0 0 6px 0;">交易可用性：方向命中率/混淆矩阵</h3>
        <table id="tradeTable"></table>
      </div>
      <div>
        <h3 style="margin: 0 0 6px 0;">条件分布（按 VIX 次日信号涨/跌分组）</h3>
        <table id="condTable"></table>
      </div>
    </div>

    <div class="panel">
      <h3 style="margin: 0 0 6px 0;">简单策略回测（risk-on/off，含换仓成本）</h3>
      <div id="stratChart"></div>
      <div class="muted" id="stratMetrics" style="margin-top:6px;"></div>
    </div>

    <div class="panel">
      <h3 style="margin: 0 0 6px 0;">择时策略绩效对比（开启择时后）</h3>
      <table id="timingCompare"></table>
    </div>

    <div class="panel">
      <h3 style="margin: 0 0 6px 0;">实盘信号回测（VXN 次日 BUY/SELL/HOLD）</h3>
      <div class="row" style="margin-bottom: 8px;">
        <div>
          <label>初始仓位</label>
          <select id="vixInitPos">
            <option value="long" selected>long（持有ETF）</option>
            <option value="cash">cash（空仓/现金）</option>
          </select>
        </div>
        <div>
          <label>日志显示条数</label>
          <input id="vixLogLimit" value="300" title="页面只渲染最近 N 条（按日期倒序），接口会返回全量。" />
        </div>
        <button id="runVixBt">运行信号回测</button>
      </div>
      <div id="vixBtChart"></div>
      <div class="muted" id="vixBtMetrics" style="margin-top:6px;"></div>
      <div class="panel">
        <h3 style="margin: 10px 0 6px 0; font-size: 15px;">信号/交易日志（日期倒序）</h3>
        <table id="vixBtTrades"></table>
      </div>
    </div>

    <div class="panel">
      <h3 style="margin: 0 0 6px 0;">滚动稳定性（窗口=252）</h3>
      <div id="rollingChart"></div>
    </div>

    <div class="panel">
      <h3 style="margin: 0 0 6px 0;">Walk-forward（训练选参 → 测试验证）</h3>
      <table id="wfTable"></table>
    </div>

    <div class="panel">
      <h3 style="margin: 0 0 6px 0;">指数分布统计（GVZ / VXN）</h3>
      <div class="row">
        <div>
          <label>指数</label>
          <select id="distSymbol">
            <option value="VXN" selected>VXN</option>
            <option value="GVZ">GVZ</option>
          </select>
        </div>
        <div>
          <label>区间</label>
          <select id="distWindow">
            <option value="1y">近1年</option>
            <option value="3y" selected>近3年</option>
            <option value="5y">近5年</option>
            <option value="10y">近10年</option>
            <option value="all">全部</option>
          </select>
        </div>
        <button id="runDist">运行分布统计</button>
      </div>
      <div class="panel two">
        <div>
          <h3 style="margin: 0 0 6px 0;">指数水平分布（close）</h3>
          <div id="distCloseChart"></div>
          <table id="distCloseTable"></table>
        </div>
        <div>
          <h3 style="margin: 0 0 6px 0;">日收益分布（log-ret）</h3>
          <div id="distRetChart"></div>
          <table id="distRetTable"></table>
        </div>
      </div>
    </div>

    <script>
      const api = (path, opts) => fetch(`/api${path}`, { headers: { "Content-Type": "application/json" }, ...opts });
      const $ = (id) => document.getElementById(id);
      const setMsg = (t) => ($("msg").textContent = t || "");

      function ymdTodayMinus(days) {
        const d = new Date(Date.now() - days * 86400 * 1000);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        return `${y}${m}${dd}`;
      }

      function fmt(x, k=4) {
        const n = Number(x);
        if (!Number.isFinite(n)) return "";
        return n.toFixed(k);
      }

      function renderTables(res) {
        const xs = (res && res.corr && res.corr.by_lag) ? res.corr.by_lag : [];
        const best = (res && res.corr && res.corr.best) ? res.corr.best : null;
        const rel = (res && res.corr && res.corr.relation) ? res.corr.relation : "";
        let html = "<tr><th>lag</th><th>corr</th><th>pvalue</th><th>n</th></tr>";
        for (const r of xs) {
          const isBest = best && Number(r.lag) === Number(best.lag);
          html += `<tr${isBest ? ' style="background:#fff7e6"' : ""}><td>${r.lag}</td><td>${fmt(r.corr,4)}</td><td>${fmt(r.pvalue,4)}</td><td>${r.n}</td></tr>`;
        }
        $("xcorrTable").innerHTML = html;

        const g1 = (res && res.granger && res.granger.idx_to_etf) ? res.granger.idx_to_etf : [];
        const g2 = (res && res.granger && res.granger.etf_to_idx) ? res.granger.etf_to_idx : [];
        let ghtml = "<tr><th>p</th><th>idx→etf pvalue</th><th>etf→idx pvalue</th></tr>";
        const n = Math.max(g1.length, g2.length);
        for (let i = 0; i < n; i++) {
          const a = g1[i] || {};
          const b = g2[i] || {};
          ghtml += `<tr><td>${a.p ?? b.p ?? ""}</td><td>${fmt(a.pvalue,4)}</td><td>${fmt(b.pvalue,4)}</td></tr>`;
        }
        $("grangerTable").innerHTML = ghtml;

        const s = (res && res.granger && res.granger.summary) ? res.granger.summary : {};
        setMsg(
          `结论（粗略）：relation=${rel}\n` +
          `best_lag=${best ? best.lag : ""}, best_corr=${best ? fmt(best.corr,4) : ""}, best_p=${best ? fmt(best.pvalue,4) : ""}\n` +
          `granger idx→etf min_p=${fmt(s.idx_causes_etf_min_p,4)}; etf→idx min_p=${fmt(s.etf_causes_idx_min_p,4)} (alpha=${fmt(s.alpha,4)})`
        );
      }

      function renderTrade(res) {
        const t = (res && res.trade) ? res.trade : null;
        if (!t) return;
        const d = t.direction || {};
        $("tradeTable").innerHTML =
          "<tr><th>样本数</th><th>命中率</th><th>TP</th><th>TN</th><th>FP</th><th>FN</th></tr>" +
          `<tr><td>${d.n ?? ""}</td><td>${fmt(d.hit_rate,4)}</td><td>${d.tp ?? ""}</td><td>${d.tn ?? ""}</td><td>${d.fp ?? ""}</td><td>${d.fn ?? ""}</td></tr>`;

        const c = t.conditional || {};
        const up = c.idx_up || {};
        const dn = c.idx_down || {};
        $("condTable").innerHTML =
          "<tr><th>分组</th><th>n</th><th>mean</th><th>q5</th><th>q25</th><th>q50</th><th>q75</th><th>q95</th></tr>" +
          `<tr><td>VIX↑(信号日)</td><td>${up.n ?? ""}</td><td>${fmt(up.mean,6)}</td><td>${fmt(up.q5,6)}</td><td>${fmt(up.q25,6)}</td><td>${fmt(up.q50,6)}</td><td>${fmt(up.q75,6)}</td><td>${fmt(up.q95,6)}</td></tr>` +
          `<tr><td>VIX↓(信号日)</td><td>${dn.n ?? ""}</td><td>${fmt(dn.mean,6)}</td><td>${fmt(dn.q5,6)}</td><td>${fmt(dn.q25,6)}</td><td>${fmt(dn.q50,6)}</td><td>${fmt(dn.q75,6)}</td><td>${fmt(dn.q95,6)}</td></tr>`;

        const s = t.strategy || {};
        const dates = s.dates || [];
        const navS = s.nav_strategy || [];
        const navB = s.nav_buy_hold || [];
        const traces = [
          { x: dates, y: navS, name: "信号策略NAV", type: "scatter", mode: "lines" },
          { x: dates, y: navB, name: "买入持有NAV", type: "scatter", mode: "lines" },
        ];
        const vt = t.vol_timing || null;
        if (vt && vt.ok) {
          const vDates = vt.dates || [];
          const vNav = vt.nav_strategy || [];
          traces.unshift({ x: vDates, y: vNav, name: "波动率择时NAV", type: "scatter", mode: "lines" });
        }
        Plotly.newPlot("stratChart", traces, { margin: { t: 20 } }, { displayModeBar: false });

        const m = (s.metrics || {});
        const ms = (m.strategy || {});
        const mb = (m.buy_hold || {});
        const fmtPct = (x) => (Number.isFinite(Number(x)) ? (Number(x) * 100).toFixed(2) + "%" : "");
        let metricsLine =
          `信号策略：CAGR=${fmtPct(ms.cagr)} Vol=${fmtPct(ms.vol)} Sharpe=${fmt(ms.sharpe,2)} MDD=${fmtPct(ms.max_drawdown)} | ` +
          `买入持有：CAGR=${fmtPct(mb.cagr)} Vol=${fmtPct(mb.vol)} Sharpe=${fmt(mb.sharpe,2)} MDD=${fmtPct(mb.max_drawdown)}`;
        if (vt && vt.ok) {
          const vms = (vt.metrics && vt.metrics.strategy) ? vt.metrics.strategy : {};
          metricsLine =
            `波动率择时：CAGR=${fmtPct(vms.cagr)} Vol=${fmtPct(vms.vol)} Sharpe=${fmt(vms.sharpe,2)} MDD=${fmtPct(vms.max_drawdown)} | ` +
            metricsLine;
        }
        $("stratMetrics").textContent = metricsLine;

        const r = t.rolling || {};
        const rd = r.dates || [];
        Plotly.newPlot("rollingChart", [
          { x: rd, y: (r.corr || []), name: "rolling corr(etf_ret, vix_ret_lag)", type: "scatter", mode: "lines" },
          { x: rd, y: (r.hit_rate || []), name: "rolling hit_rate", yaxis: "y2", type: "scatter", mode: "lines" },
        ], { margin: { t: 20 }, yaxis: { title: "corr" }, yaxis2: { title: "hit", overlaying: "y", side: "right" } }, { displayModeBar: false });

        // threshold + walk-forward summary
        const th = t.threshold || {};
        const wf = t.walk_forward || {};
        const thStrat = th.strategy ? th.strategy : null;
        const thM = thStrat && thStrat.metrics ? thStrat.metrics.strategy : null;
        const thLine = thStrat
          ? `threshold(q=${fmt(th.quantile,2)} abs=${fmt(thStrat.threshold_abs,6)} active_rate=${fmt(thStrat.active_rate,3)}): ` +
            `CAGR=${fmtPct(thM && thM.cagr)} Sharpe=${fmt(thM && thM.sharpe,2)} MDD=${fmtPct(thM && thM.max_drawdown)}`
          : `threshold(q=${fmt(th.quantile,2)}): 无法计算（样本不足或缺失）`;

        let wfHtml = "<tr><th>项</th><th>内容</th></tr>";
        wfHtml += `<tr><td>阈值信号</td><td>${thLine}</td></tr>`;
        if (vt) {
          if (vt.ok) {
            const vms = (vt.metrics && vt.metrics.strategy) ? vt.metrics.strategy : {};
            const thrAbs = (vt.thresholds_abs_train || vt.thresholds_abs || []).map(x => fmt(x, 6)).join(", ");
            const exps = (vt.exposures || []).map(x => fmt(x, 3)).join(", ");
            const rates = (vt.bucket_rates || []).map(x => fmt(x, 3)).join(", ");
            wfHtml += `<tr><td>波动率择时(全样本)</td><td>quantiles=${(vt.quantiles || []).map(x => fmt(x, 2)).join(", ")}; thresholds_abs=[${thrAbs}]; exposures=[${exps}]; bucket_rates=[${rates}] | CAGR=${fmtPct(vms.cagr)} Sharpe=${fmt(vms.sharpe,2)} MDD=${fmtPct(vms.max_drawdown)}</td></tr>`;
            const vwf = vt.walk_forward || null;
            if (vwf && vwf.ok) {
              const trn2 = (vwf.train && vwf.train.metrics && vwf.train.metrics.strategy) ? vwf.train.metrics.strategy : {};
              const tst2 = (vwf.test && vwf.test.metrics && vwf.test.metrics.strategy) ? vwf.test.metrics.strategy : {};
              wfHtml += `<tr><td>波动率择时(WF)</td><td>train_ratio=${fmt(vwf.train_ratio,2)}; thr_train=[${(vwf.thresholds_abs_train || []).map(x => fmt(x,6)).join(", ")}]</td></tr>`;
              wfHtml += `<tr><td>WF训练段</td><td>CAGR=${fmtPct(trn2.cagr)} Sharpe=${fmt(trn2.sharpe,2)} MDD=${fmtPct(trn2.max_drawdown)}</td></tr>`;
              wfHtml += `<tr><td>WF测试段</td><td>CAGR=${fmtPct(tst2.cagr)} Sharpe=${fmt(tst2.sharpe,2)} MDD=${fmtPct(tst2.max_drawdown)}</td></tr>`;
            } else if (vwf) {
              wfHtml += `<tr><td>波动率择时(WF)</td><td>无法计算（${vwf.reason || "样本不足"}）</td></tr>`;
            }
          } else {
            wfHtml += `<tr><td>波动率择时</td><td>无法计算（${vt.error || "参数/样本不足"}）</td></tr>`;
          }
        }
        if (wf && wf.ok) {
          const ch = wf.chosen || {};
          const trn = (wf.train && wf.train.strategy && wf.train.strategy.metrics && wf.train.strategy.metrics.strategy) ? wf.train.strategy.metrics.strategy : {};
          const tst = (wf.test && wf.test.strategy && wf.test.strategy.metrics && wf.test.strategy.metrics.strategy) ? wf.test.strategy.metrics.strategy : {};
          wfHtml += `<tr><td>Walk-forward 选参</td><td>objective=${wf.objective}, lag=${ch.lag}, thr_q=${ch.thr_q}, thr_abs=${fmt(ch.thr_abs,6)}, corr_train=${fmt(ch.corr_train,4)}</td></tr>`;
          wfHtml += `<tr><td>训练段</td><td>${wf.train.start} ~ ${wf.train.end} | CAGR=${fmtPct(trn.cagr)} Sharpe=${fmt(trn.sharpe,2)} MDD=${fmtPct(trn.max_drawdown)}</td></tr>`;
          wfHtml += `<tr><td>测试段</td><td>${wf.test.start} ~ ${wf.test.end} | CAGR=${fmtPct(tst.cagr)} Sharpe=${fmt(tst.sharpe,2)} MDD=${fmtPct(tst.max_drawdown)}</td></tr>`;
        } else {
          wfHtml += `<tr><td>Walk-forward</td><td>无法计算（${wf && wf.reason ? wf.reason : "样本不足"}）</td></tr>`;
        }
        $("wfTable").innerHTML = wfHtml;

        // ---- timing compare (VXN + spot-vol proxies) ----
        function renderTimingCompare(rows) {
          const el = $("timingCompare");
          if (!el) return;
          if (!rows || !rows.length) {
            el.innerHTML = "<tr><td class='muted'>未启用择时或样本不足</td></tr>";
            return;
          }
          let html = "<tr><th>策略</th><th>CAGR</th><th>Vol</th><th>Sharpe</th><th>MDD</th><th>备注</th></tr>";
          for (const r of rows) {
            html += `<tr><td>${r.name}</td><td>${r.cagr}</td><td>${r.vol}</td><td>${r.sharpe}</td><td>${r.mdd}</td><td>${r.note || ""}</td></tr>`;
          }
          el.innerHTML = html;
        }

        function metricRow(name, ms, note) {
          const fmtPct2 = (x) => (Number.isFinite(Number(x)) ? (Number(x) * 100).toFixed(2) + "%" : "");
          return {
            name,
            cagr: fmtPct2(ms && ms.cagr),
            vol: fmtPct2(ms && ms.vol),
            sharpe: fmt(ms && ms.sharpe, 2),
            mdd: fmtPct2(ms && ms.max_drawdown),
            note: note || "",
          };
        }

        async function runProxyTimingCompare() {
          const enabled = Boolean($("volOn").checked) && Boolean($("proxyOn").checked);
          if (!enabled) {
            renderTimingCompare([]);
            return;
          }
          const rows = [];
          if (vt && vt.ok) {
            rows.push(metricRow("指数波动择时(VXN)", (vt.metrics && vt.metrics.strategy) ? vt.metrics.strategy : {}, "index_level"));
          }

          const asset_provider = ($("assetProvider").value || "db").trim();
          if (asset_provider !== "db") {
            rows.push({ name: "现货波动择时(ETFOHLC)", cagr: "", vol: "", sharpe: "", mdd: "", note: "跳过：仅支持 DB 的 513100" });
            renderTimingCompare(rows);
            return;
          }

          const parseNums = (s) =>
            (String(s || "")
              .split(",")
              .map(x => Number(String(x).trim()))
              .filter(x => Number.isFinite(x)));
          const level_quantiles = parseNums(($("volQs").value || "").trim());
          const level_exposures = parseNums(($("volExps").value || "").trim());
          const level_window = ($("volWindow").value || "all").trim();
          const trade_cost_bps = Number(($("costBps").value || "0").trim());
          const train_ratio = Number(($("trainRatio").value || "0.6").trim());
          const start = ($("start").value || "").trim();
          const end = ($("end").value || "").trim();
          const adjust = ($("adjust").value || "hfq").trim();

          const methods = [];
          const add = (id, name, kind, extra={}) => {
            if (!$(id) || !$(id).checked) return;
            methods.push({ name, kind, window: 20, ann: 252, ...extra });
          };
          add("proxy_rv20", "RV20", "rv_close");
          add("proxy_yz20", "YZ20", "yang_zhang");
          add("proxy_gk20", "GK20", "garman_klass");
          add("proxy_ewma094", "EWMA094", "ewma_close", { ewma_lambda: 0.94 });
          add("proxy_har252", "HAR252", "har_rv", { har_train_window: 252, har_horizons: [1,5,22] });

          if (!methods.length) {
            renderTimingCompare(rows);
            return;
          }
          $("timingCompare").innerHTML = "<tr><td class='muted'>现货波动择时计算中...</td></tr>";
          try {
            const resp2 = await api("/analysis/vol-proxy-timing", {
              method: "POST",
              body: JSON.stringify({
                etf_code: "513100",
                start,
                end,
                adjust,
                methods,
                level_quantiles,
                level_exposures,
                level_window,
                trade_cost_bps,
                walk_forward: true,
                train_ratio,
              }),
            });
            const d2 = await resp2.json();
            if (!d2 || !d2.ok) {
              rows.push({ name: "现货波动择时(ETFOHLC)", cagr: "", vol: "", sharpe: "", mdd: "", note: `失败：${d2 && (d2.error || "unknown")}` });
              renderTimingCompare(rows);
              return;
            }
            const ms = d2.methods || {};
            for (const [k, v] of Object.entries(ms)) {
              if (!v || !v.ok) {
                rows.push({ name: `现货波动择时(${k})`, cagr: "", vol: "", sharpe: "", mdd: "", note: `失败：${v && v.error ? v.error : "bad"}` });
                continue;
              }
              const mstr = (v.metrics && v.metrics.strategy) ? v.metrics.strategy : {};
              rows.push(metricRow(`现货波动择时(${k})`, mstr, (v.thresholds_abs_train ? `thr=${(v.thresholds_abs_train || []).map(x => fmt(x,3)).join(",")}` : "")));
            }
            renderTimingCompare(rows);
          } catch (e) {
            rows.push({ name: "现货波动择时(ETFOHLC)", cagr: "", vol: "", sharpe: "", mdd: "", note: `异常：${e && e.message ? e.message : String(e)}` });
            renderTimingCompare(rows);
          }
        }

        runProxyTimingCompare();
      }

      function renderCharts(res) {
        const dates = (res && res.series && res.series.dates) ? res.series.dates : [];
        const etfClose = (res && res.series && res.series.etf_close) ? res.series.etf_close : [];
        const idxClose = (res && res.series && res.series.idx_close) ? res.series.idx_close : [];
        const etfRet = (res && res.series && res.series.etf_ret) ? res.series.etf_ret : [];
        const idxRet = (res && res.series && res.series.idx_ret) ? res.series.idx_ret : [];

        const etf0 = Number(etfClose[0] || 1);
        const idx0 = Number(idxClose[0] || 1);
        const etfNorm = etfClose.map(v => Number(v) / etf0);
        const idxNorm = idxClose.map(v => Number(v) / idx0);
        const assetName = (res && res.meta && (res.meta.asset_symbol || res.meta.etf_code)) ? (res.meta.asset_symbol || res.meta.etf_code) : "ASSET";
        const idxName = (res && res.meta && (res.meta.index || res.meta.symbol || res.meta.series_id)) ? (res.meta.index || res.meta.symbol || res.meta.series_id) : "INDEX";

        Plotly.newPlot("pxChart", [
          { x: dates, y: etfNorm, name: `${assetName} close(归一化)`, type: "scatter", mode: "lines" },
          { x: dates, y: idxNorm, name: `${idxName} close(归一化)`, type: "scatter", mode: "lines" },
        ], { margin: { t: 20 } }, { displayModeBar: false });

        Plotly.newPlot("retChart", [
          { x: dates, y: etfRet, name: "ETF log-ret", type: "scatter", mode: "lines" },
          { x: dates, y: idxRet, name: "Index log-ret", type: "scatter", mode: "lines" },
        ], { margin: { t: 20 } }, { displayModeBar: false });

        const xs = (res && res.corr && res.corr.by_lag) ? res.corr.by_lag : [];
        Plotly.newPlot("xcorrChart", [
          { x: xs.map(r => r.lag), y: xs.map(r => r.corr), type: "bar", name: "corr" },
        ], { margin: { t: 20 }, xaxis: { title: "lag (days)" }, yaxis: { title: "corr" } }, { displayModeBar: false });
      }

      function _renderQuantTable(elId, q) {
        const qs = q || {};
        const keys = Object.keys(qs);
        let html = "<tr><th>quantile</th><th>value</th></tr>";
        for (const k of keys) {
          html += `<tr><td>${k}</td><td>${fmt(qs[k], 6)}</td></tr>`;
        }
        $(elId).innerHTML = html;
      }

      function renderIndexDist(d) {
        if (!d || !d.ok) return;
        const m = d.meta || {};
        const c = (d.close || {});
        const r = (d.ret_log || {});
        const ch = (c.hist || {});
        const rh = (r.hist || {});

        const cbins = ch.bins || [];
        const ccounts = ch.counts || [];
        const cx = cbins.slice(0, Math.max(0, cbins.length - 1));
        Plotly.newPlot("distCloseChart", [
          { x: cx, y: ccounts, type: "bar", name: `${m.symbol || ""} close` },
        ], { margin: { t: 20 }, xaxis: { title: "close" }, yaxis: { title: "count" } }, { displayModeBar: false });
        _renderQuantTable("distCloseTable", c.quantiles || {});

        const rbins = rh.bins || [];
        const rcounts = rh.counts || [];
        const rx = rbins.slice(0, Math.max(0, rbins.length - 1));
        Plotly.newPlot("distRetChart", [
          { x: rx, y: rcounts, type: "bar", name: `${m.symbol || ""} log-ret` },
        ], { margin: { t: 20 }, xaxis: { title: "log-ret" }, yaxis: { title: "count" } }, { displayModeBar: false });
        _renderQuantTable("distRetTable", r.quantiles || {});
      }

      function renderVixBacktest(bt) {
        if (!bt || !bt.ok) return;
        const s = bt.series || {};
        const dates = s.dates || [];
        const navS = s.nav_strategy || [];
        const navB = s.nav_buy_hold || [];
        Plotly.newPlot("vixBtChart", [
          { x: dates, y: navS, name: "信号策略NAV", type: "scatter", mode: "lines" },
          { x: dates, y: navB, name: "买入并持有NAV", type: "scatter", mode: "lines" },
        ], { margin: { t: 20 } }, { displayModeBar: false });

        const m = bt.metrics || {};
        const ms = m.strategy || {};
        const mb = m.buy_hold || {};
        const fmtPct = (x) => (Number.isFinite(Number(x)) ? (Number(x) * 100).toFixed(2) + "%" : "");
        $("vixBtMetrics").textContent =
          `信号策略：CAGR=${fmtPct(ms.cagr)} Vol=${fmtPct(ms.vol)} Sharpe=${fmt(ms.sharpe,2)} MDD=${fmtPct(ms.max_drawdown)} | ` +
          `买入并持有：CAGR=${fmtPct(mb.cagr)} Vol=${fmtPct(mb.vol)} Sharpe=${fmt(mb.sharpe,2)} MDD=${fmtPct(mb.max_drawdown)}`;

        const trades = bt.trades || [];
        const lim = Math.max(1, Number(($("vixLogLimit").value || "300").trim()));
        const shown = trades.slice(0, lim);
        let html = "<tr><th>date(CN)</th><th>action</th><th>pos</th><th>IDX_us_date</th><th>IDX_close</th><th>IDX_log_ret</th><th>thr</th><th>active</th><th>ETF_ret</th><th>NAV</th><th>BH_NAV</th></tr>";
        for (const r of shown) {
          const act = (r.action || "").toUpperCase();
          const bg = act === "BUY" ? "#e6fffb" : (act === "SELL" ? "#fff1f0" : "");
          html += `<tr${bg ? ` style="background:${bg}"` : ""}>` +
            `<td>${r.date || ""}</td>` +
            `<td>${act}</td>` +
            `<td>${r.position || ""}</td>` +
            `<td>${r.idx_us_date || ""}</td>` +
            `<td>${fmt(r.idx_close,2)}</td>` +
            `<td>${fmt(r.idx_log_ret,6)}</td>` +
            `<td>${fmt(r.thr_eff,6)}</td>` +
            `<td>${r.sig_active ? "Y" : ""}</td>` +
            `<td>${fmt(r.etf_ret,6)}</td>` +
            `<td>${fmt(r.nav_strategy,4)}</td>` +
            `<td>${fmt(r.nav_buy_hold,4)}</td>` +
          `</tr>`;
        }
        const note = `<tr><td colspan="11" class="muted">总记录=${trades.length}，当前显示前 ${shown.length} 条（按日期倒序）。</td></tr>`;
        $("vixBtTrades").innerHTML = html + note;
      }

      async function run() {
        const start = ($("start").value || "").trim();
        const end = ($("end").value || "").trim();
        const adjust = ($("adjust").value || "hfq").trim();
        const index_symbol = ($("idx").value || "VXN").trim();
        const index_provider = ($("idxProvider").value || "cboe").trim();
        const index_align = ($("align").value || "cn_next_trading_day").trim();
        const max_lag = Number(($("maxLag").value || "20").trim());
        const granger_max_lag = Number(($("grangerLag").value || "10").trim());
        const alpha = Number(($("alpha").value || "0.05").trim());
        const trade_cost_bps = Number(($("costBps").value || "0").trim());
        const threshold_quantile = Number(($("thrQ").value || "0.8").trim());
        const train_ratio = Number(($("trainRatio").value || "0.6").trim());
        const walk_objective = ($("wfObj").value || "sharpe").trim();
        const vol_timing = Boolean($("volOn").checked);
        const parseNums = (s) =>
          (String(s || "")
            .split(",")
            .map(x => Number(String(x).trim()))
            .filter(x => Number.isFinite(x)));
        const vol_level_quantiles = parseNums(($("volQs").value || "").trim());
        const vol_level_exposures = parseNums(($("volExps").value || "").trim());
        const vol_level_window = ($("volWindow").value || "all").trim();
        const asset_provider = ($("assetProvider").value || "db").trim();
        const asset_symbol = ($("assetSymbol").value || "").trim();
        const preset = ($("assetPreset").value || "").trim();
        const label = preset.includes("stooq:^ndx") ? "NDX" : (preset.includes("stooq:qqq.us") ? "QQQ" : "513100");

        setMsg("运行中...");
        const resp = await api("/analysis/leadlag", {
          method: "POST",
          body: JSON.stringify({
            etf_code: label,
            asset_provider,
            asset_symbol: asset_provider === "db" ? null : asset_symbol,
            index_symbol,
            index_provider,
            index_align,
            start,
            end,
            adjust,
            max_lag,
            granger_max_lag,
            alpha,
            trade_cost_bps,
            rolling_window: 252,
            enable_threshold: true,
            threshold_quantile,
            walk_forward: true,
            train_ratio,
            walk_objective,
            vol_timing,
            vol_level_quantiles,
            vol_level_exposures,
            vol_level_window,
          }),
        });
        const data = await resp.json();
        if (!data || !data.ok) {
          setMsg(`失败：${data && (data.error || JSON.stringify(data))}`);
          return;
        }
        renderCharts(data);
        renderTables(data);
        renderTrade(data);
      }

      async function runDist() {
        const symbol = ($("distSymbol").value || "VXN").trim();
        const window = ($("distWindow").value || "3y").trim();
        const resp = await api("/analysis/index-distribution", {
          method: "POST",
          body: JSON.stringify({ symbol, window, bins: 60 }),
        });
        const data = await resp.json();
        if (!data || !data.ok) {
          setMsg(`分布统计失败：${data && (data.error || JSON.stringify(data))}`);
          return;
        }
        renderIndexDist(data);
      }

      function _applyAssetPreset() {
        const v = ($("assetPreset").value || "").trim();
        const parts = v.split(":");
        const p = (parts[0] || "db").trim();
        const sym = (parts[1] || "").trim();
        if (p === "db") {
          $("assetProvider").value = "db";
          $("assetSymbol").value = "";
          $("adjust").disabled = false;
          $("align").value = "cn_next_trading_day";
        } else if (p === "stooq") {
          $("assetProvider").value = "stooq";
          $("assetSymbol").value = sym;
          $("adjust").disabled = true;
          $("align").value = "none";
        }
      }

      function _applyIdxPreset() {
        const v = ($("idxPreset").value || "").trim();
        const parts = v.split(":");
        const p = (parts[0] || "cboe").trim();
        const sym = (parts[1] || "").trim();
        if (p !== "custom") {
          $("idxProvider").value = p;
          $("idx").value = sym;
        }
      }

      async function runVixBt() {
        const start = ($("start").value || "").trim();
        const end = ($("end").value || "").trim();
        const adjust = ($("adjust").value || "hfq").trim();
        const index = ($("idx").value || "VXN").trim();
        const index_align = ($("align").value || "cn_next_trading_day").trim();
        const trade_cost_bps = Number(($("costBps").value || "0").trim());
        const threshold_quantile = Number(($("thrQ").value || "0.8").trim());
        const initial_position = ($("vixInitPos").value || "long").trim();

        setMsg("运行中（信号回测）...");
        const resp = await api("/analysis/vix-signal-backtest", {
          method: "POST",
          body: JSON.stringify({
            etf_code: "513100",
            start,
            end,
            adjust,
            index,
            index_align,
            calendar: "XSHG",
            lookback_window: 252,
            threshold_quantile,
            min_abs_ret: 0.0,
            trade_cost_bps,
            initial_position,
            initial_nav: 1.0,
          }),
        });
        const bt = await resp.json();
        if (!bt || !bt.ok) {
          setMsg(`失败：${bt && (bt.error || JSON.stringify(bt))}`);
          return;
        }
        renderVixBacktest(bt);
        setMsg("完成。");
      }

      $("end").value = ymdTodayMinus(0);
      $("start").value = ymdTodayMinus(365 * 5);
      $("run").addEventListener("click", run);
      $("runVixBt").addEventListener("click", runVixBt);
      $("runDist").addEventListener("click", runDist);
      $("assetPreset").addEventListener("change", _applyAssetPreset);
      $("idxPreset").addEventListener("change", _applyIdxPreset);
      _applyAssetPreset();
      _applyIdxPreset();
    </script>
  </body>
</html>

